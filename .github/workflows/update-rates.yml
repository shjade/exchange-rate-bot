name: Update Exchange Rates

on:
  schedule:
    - cron: "*/10 * * * *"   # 10분마다
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests

      - name: Fetch exchange rate (AlphaVantage)
        env:
          ALPHAVANTAGE_API_KEY: ${{ secrets.ALPHAVANTAGE_API_KEY }}
        run: |
          python <<'PY'
          import os, json, datetime, sys
          from pathlib import Path
          import requests

          api_key = os.environ.get("ALPHAVANTAGE_API_KEY", "").strip()
          if not api_key:
              print("ERROR: ALPHAVANTAGE_API_KEY secret is not set.")
              sys.exit(1)

          url = "https://www.alphavantage.co/query"
          params = {
              "function": "CURRENCY_EXCHANGE_RATE",
              "from_currency": "USD",
              "to_currency": "KRW",
              "apikey": api_key
          }

          r = requests.get(url, params=params, timeout=15)
          try:
              j = r.json()
          except Exception:
              print("ERROR: Non-JSON response:", r.status_code)
              print(r.text[:500])
              sys.exit(1)

          # 정상 키가 없으면(레이트리밋/키오류 등) 기존 값 유지하고 워크플로우는 실패시키지 않음
          key = "Realtime Currency Exchange Rate"
          out_path = Path("docs/data/exchange_rates.json")
          out_path.parent.mkdir(parents=True, exist_ok=True)

          if key not in j:
              print("WARN: Unexpected AlphaVantage response (keeping previous data).")
              print(json.dumps(j, indent=2)[:1200])

              if out_path.exists():
                  # 기존 파일 유지 (그대로 두면 add/commit에서 변경 없음)
                  sys.exit(0)
              else:
                  print("ERROR: No previous exchange_rates.json exists to fall back to.")
                  sys.exit(1)

          data = j[key]
          result = {
              "pair": "USD_KRW",
              "rate": float(data["5. Exchange Rate"]),
              "api_as_of": data["6. Last Refreshed"],
              "fetched_at_utc": datetime.datetime.utcnow().isoformat() + "Z",
              "source": "AlphaVantage"
          }

          out_path.write_text(json.dumps(result, indent=2), encoding="utf-8")
          print("OK:", result)
          PY


      

      - name: Update README
        run: |
          python <<'PY'
          import json, re
          from pathlib import Path

          data = json.loads(Path("docs/data/exchange_rates.json").read_text())
          rate = data["rate"]
          time = data["api_as_of"]

          readme = Path("README.md").read_text()
          block = (
              "<!-- RATE:START -->\n"
              f"USD → KRW: **{rate:,.2f}**  \n"
              f"_Last update: {time}_\n"
              "<!-- RATE:END -->"
          )

          readme = re.sub(
              r"<!-- RATE:START -->(.|\n)*?<!-- RATE:END -->",
              block,
              readme
          )

          Path("README.md").write_text(readme)
          PY

      - name: Generate badge.svg
        run: |
          python <<'PY'
          import json
          from pathlib import Path

          data = json.loads(Path("docs/data/exchange_rates.json").read_text())
          rate = data["rate"]

          svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="320" height="44">
            <rect width="320" height="44" rx="10" fill="#0d1117"/>
            <text x="16" y="28" font-size="18" fill="#ffffff"
              font-family="Arial, Helvetica, sans-serif">
              USD → KRW {rate:,.2f}
            </text>
          </svg>'''

          Path("docs/badge.svg").write_text(svg)
          PY

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md docs/data/exchange_rates.json docs/badge.svg
          git commit -m "chore: update exchange rate (readme + badge)" || echo "No changes"
          git push
