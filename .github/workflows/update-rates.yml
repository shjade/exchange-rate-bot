name: Update Exchange Rates

on:
  schedule:
    - cron: "*/10 * * * *"   # 10분마다
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests

      - name: Fetch exchange rate (AlphaVantage)
        env:
          ALPHAVANTAGE_API_KEY: ${{ secrets.ALPHAVANTAGE_API_KEY }}
        run: |
          python <<'PY'
          import requests, json, datetime, os
          url = "https://www.alphavantage.co/query"
          params = {
              "function": "CURRENCY_EXCHANGE_RATE",
              "from_currency": "USD",
              "to_currency": "KRW",
              "apikey": os.environ["ALPHAVANTAGE_API_KEY"]
          }

          r = requests.get(url, params=params, timeout=10)
          data = r.json()["Realtime Currency Exchange Rate"]

          result = {
              "pair": "USD_KRW",
              "rate": float(data["5. Exchange Rate"]),
              "api_as_of": data["6. Last Refreshed"],
              "fetched_at_utc": datetime.datetime.utcnow().isoformat()
          }

          os.makedirs("docs/data", exist_ok=True)
          with open("docs/data/exchange_rates.json", "w") as f:
              json.dump(result, f, indent=2)
          PY

      - name: Update README
        run: |
          python <<'PY'
          import json, re
          from pathlib import Path

          data = json.loads(Path("docs/data/exchange_rates.json").read_text())
          rate = data["rate"]
          time = data["api_as_of"]

          readme = Path("README.md").read_text()
          block = (
              "<!-- RATE:START -->\n"
              f"USD → KRW: **{rate:,.2f}**  \n"
              f"_Last update: {time}_\n"
              "<!-- RATE:END -->"
          )

          readme = re.sub(
              r"<!-- RATE:START -->(.|\n)*?<!-- RATE:END -->",
              block,
              readme
          )

          Path("README.md").write_text(readme)
          PY

      - name: Generate badge.svg
        run: |
          python <<'PY'
          import json
          from pathlib import Path

          data = json.loads(Path("docs/data/exchange_rates.json").read_text())
          rate = data["rate"]

          svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="320" height="44">
            <rect width="320" height="44" rx="10" fill="#0d1117"/>
            <text x="16" y="28" font-size="18" fill="#ffffff"
              font-family="Arial, Helvetica, sans-serif">
              USD → KRW {rate:,.2f}
            </text>
          </svg>'''

          Path("docs/badge.svg").write_text(svg)
          PY

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md docs/data/exchange_rates.json docs/badge.svg
          git commit -m "chore: update exchange rate (readme + badge)" || echo "No changes"
          git push
